default_platform(:ios)

platform :ios do
  desc "Build the iOS application for App Store distribution"
  lane :build_release do
    begin
      # 1. Setup CI environment and keychain
      # setup_ci(force: true)
      cert_file_path = File.expand_path("certificate.p12")
      File.open(cert_file_path, "wb") do |file|
        file.write(Base64.decode64(ENV("APPLE_CERTIFICATE_BASE64")))
      end
      create_keychain(
        name: cert_file_path,
        password: ENV['APPLE_CERTIFICATE_PASSWORD'],
        timeout: 1800
      )      

      # 2. Decode and install provisioning profile
      prov_profile_path = File.expand_path("profile.mobileprovision")
      File.open(prov_profile_path, "wb") do |file|
        file.write(Base64.decode64(ENV["PROVISIONING_PROFILE_BASE64"]))
      end
      install_provisioning_profile(path: prov_profile_path)

      # 3. Set build number
      if ENV['CI_BUILD_NUMBER']
        build_number = increment_build_number
        build_number_i = build_number.to_i
        increment_build_number(
          build_number: "#(build_number_i + 1)",
          xcodeproj: "FlowCards.xcodeproj"
        )
      end

      # 4. Build the app
      # profile_uuid = lane_context[SharedValues::SIGH_UUID]
      profile_data = Plist.parse_xml(`security cms -D -i #{prov_profile_path}`)
      profile_uuid = profile_data['UUID']
      team_id = ENV["APPLE_TEAM_ID"]
      bundle_identifier = "com.mugime.flowcards"

      gym(
        scheme: "FlowCards",
        workspace: "FlowCards.xcworkspace",
        export_method: "app-store",
        output_directory: "./build",
        output_name: "FlowCards.ipa",
        clean: true,
        export_options: {
          method: "app-store",
          teamID: team_id,
          provisioningProfiles: {
            bundle_identifier => profile_uuid
          }
        }
      )
      
      UI.success("Successfully built iOS app!")
      
    rescue => e
      UI.error("Build failed: #{e.message}")
      UI.error("Backtrace: #{e.backtrace.join("\n")}")
      raise e
    ensure
      # Clean up keychain
      if File.exist?(File.expand_path("~/Library/Keychains/fastlane_tmp_keychain-db"))
        delete_keychain(name: "fastlane_tmp_keychain")
      end
    end
  end
end
