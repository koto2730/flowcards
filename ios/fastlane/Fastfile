default_platform(:ios)

platform :ios do
  desc "Build the iOS application for App Store distribution"
  lane :build_release do
    keychain_name = "fastlane_tmp_keychain"
    keychain_password = "tmp_password" # A temporary password for the keychain

    begin
      # Create and set a temporary keychain as default
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600
      )

      # Explicitly unlock the keychain to prevent UI prompts in CI
      unlock_keychain(
        name: keychain_name,
        password: keychain_password
      )

      # Import certificate into the default keychain
      import_certificate(
        keychain_name: keychain_name,
        certificate_path: ENV["CERTIFICATE_FILE_PATH"],
        certificate_password: ENV["APPLE_CERTIFICATE_PASSWORD"]
      )

      # Install provisioning profile
      install_provisioning_profile(path: ENV["PROVISIONING_PROFILE_PATH"])

      # Set build number
      increment_build_number(build_number: ENV['CI_BUILD_NUMBER']) if ENV['CI_BUILD_NUMBER']

      # Build the app
      gym(
        scheme: "FlowCards",
        export_method: "app-store",
        output_directory: "./build",
        output_name: "FlowCards.ipa"
      )
    ensure
      # Clean up the temporary keychain
      delete_keychain(name: keychain_name) if keychain_name
    end
  end
end
