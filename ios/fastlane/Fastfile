default_platform(:ios)

platform :ios do
  desc "Build the iOS application for App Store distribution"
  lane :build_release do
    keychain_name = "fastlane_tmp_keychain"
    keychain_password = "tmp_password"

    begin
      # Create a new temporary keychain for CI
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )

      # Import certificate from file path provided by CI
      import_certificate(
        keychain_name: keychain_name,
        certificate_path: ENV["CERTIFICATE_FILE_PATH"],
        certificate_password: ENV["APPLE_CERTIFICATE_PASSWORD"]
      )

      # Install provisioning profile from file path provided by CI
      install_provisioning_profile(path: ENV["PROVISIONING_PROFILE_PATH"])

      # Set build number
      build_number = ENV['CI_BUILD_NUMBER']
      increment_build_number(build_number: build_number) if build_number

      # Build the app
      gym(
        scheme: "FlowCards",
        export_method: "app-store",
        output_directory: "./build",
        output_name: "FlowCards.ipa"
      )
    ensure
      # Clean up the temporary keychain
      delete_keychain(name: keychain_name) if keychain_name
    end
  end
end
